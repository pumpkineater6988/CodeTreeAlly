{% extends 'index.html' %}
{% block page_title %}Internal AI Chatbot{% endblock %}
{% block content %}
<style>
    .thinking-indicator {
        font-style: italic;
        color: #888;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5em;
    }
    .thinking-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #888;
        display: inline-block;
        animation: blink 1.2s infinite both;
    }
    .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
        0%, 100% { opacity: 0.2; }
        50% { opacity: 1; }
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background: var(--chat-bg-light);
    }

    body.dark-mode .chat-container {
        background: var(--chat-bg-dark);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem 1rem 1rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chat-bubble {
        max-width: 75%;
        padding: 0.75rem 1.2rem;
        border-radius: 1.2rem;
        font-size: 1.05rem;
        word-break: break-word;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        position: relative;
    }

    .chat-bubble.user {
        align-self: flex-end;
        background: #2563eb;
        color: #fff;
        border-bottom-right-radius: 0.3rem;
    }

    body.dark-mode .chat-bubble.user {
        background: #1746a2;
    }

    .chat-bubble.bot {
        align-self: flex-start;
        background: #f3f4f6;
        color: #222;
        border-bottom-left-radius: 0.3rem;
    }

    body.dark-mode .chat-bubble.bot {
        background: #232323;
        color: #f1f1f1;
    }

    .chat-bubble.file {
        font-size: 0.95rem;
        color: #555;
        background: #e0e7ef;
        border: 1px solid #b6c2d1;
        margin-top: 0.3rem;
    }

    body.dark-mode .chat-bubble.file {
        background: #232323;
        border: 1px solid #444;
        color: #f1f1f1;
    }

    .chat-input-area {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-top: 1px solid var(--chat-border-light);
        background: var(--chat-input-bg-light);
        position: sticky;
        bottom: 0;
        z-index: 2;
        gap: 0.5rem;
    }

    body.dark-mode .chat-input-area {
        background: var(--chat-input-bg-dark);
        border-top: 1px solid var(--chat-border-dark);
    }

    .chat-input-area input[type="file"] {
        display: none;
    }

    .chat-input-area .attach-label {
        cursor: pointer;
        color: #2563eb;
        font-size: 1.3rem;
    }

    .chat-input-area .send-btn {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
    }

    .chat-input-area .send-btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .chat-input-area .form-control {
        background: var(--chat-input-bg-light);
        color: var(--chat-input-text-light);
        border: 1.5px solid #d0d0d0;
        border-radius: 1.5em;
        padding: 0.75em 1.1em;
        flex: 1;
    }

    body.dark-mode .chat-input-area .form-control {
        background: var(--chat-input-bg-dark);
        color: var(--chat-input-text-dark);
        border: 1.5px solid #444;
    }

    .snippet-box {
        max-width: 75%;
        background: #f5f5f5;
        color: #222;
        border-radius: 1em;
        padding: 1.5em 1.2em 1.2em 1.2em;
        position: relative;
        box-shadow: 0 1px 8px rgba(0,0,0,0.04);
        word-break: break-word;
        overflow-x: auto;
        overflow-y: auto;
        max-height: 300px;
    }

    body.dark-mode .snippet-box {
        background: #232323;
        color: #f1f1f1;
    }

    .copy-wrapper {
    	position: absolute;
    	top: 0.7em;
    	right: 1em;
    	z-index: 10;
    }
 
    .copy-icon {
    	color: #2563eb;
    	cursor: pointer;
    	font-size: 1.15em;
    	background: #f5f5f5;
    	padding: 0.3em 0.4em;
    	border-radius: 0.3em;
    }

    .copy-icon:hover {
    	background: #e0e0e0;
    }

    body.dark-mode .copy-icon {
    	background: #232323;
    }

    .copy-tooltip {
    	display: none;
    	position: absolute;
   	top: 2.2em;
    	right: 0;
    	background: #333;
    	color: #fff;
    	padding: 2px 10px;
    	border-radius: 4px;
    	font-size: 0.9em;
    	white-space: nowrap;
    	pointer-events: none;
    	z-index: 20;
    }

    .copy-wrapper:hover .copy-tooltip {
    	display: block;
    }


    .lang-badge {
        position: absolute;
        top: 1.1em;
        left: 1.1em;
        background: #e0e7ef;
        color: #2563eb;
        font-size: 0.95em;
        font-weight: 600;
        padding: 2px 12px;
        border-radius: 0.7em;
        text-transform: uppercase;
    }

    body.dark-mode .lang-badge {
        background: #181f2a;
        color: #90aaff;
    }

    @media (max-width: 900px) {
        .chat-container { max-width: 100vw; }
    }
</style>

<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        {% if chat_history %}
            {% for msg in chat_history %}
                {% if msg.role == 'user' %}
                    <div class="chat-bubble user">{{ msg.text }}</div>
                    {% if msg.file_name %}
                        <div class="chat-bubble user file"><i class="fa fa-paperclip"></i> {{ msg.file_name }}</div>
                    {% endif %}
                {% else %}
                    {% set codeblock = msg.text.find('```') != -1 %}
                    {% if codeblock %}
                        {% set parts = msg.text.split('```') %}
                        {% set lang = parts[1].split('\n')[0].strip() or 'txt' %}
                        {% set code = parts[1][lang|length+1:] if parts[1].startswith(lang) else parts[1] %}
                        <div class="snippet-box mt-4">
                            <span class="lang-badge">{{ lang|upper }}</span>
                            <div class="copy-wrapper">
                                <span class="copy-icon" onclick="copySnippet(this)" title="Copy" tabindex="0"><i class="fa fa-copy"></i></span>
                                <span class="copy-tooltip">Copy</span>
                            </div>
                            <pre style="margin-top:2.2em;">{{ code|e }}</pre>
                        </div>
                    {% else %}
                        <div class="chat-bubble bot">{{ msg.text }}</div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
        <div id="typingIndicator" style="display:none;">
            <span class="chat-bubble bot thinking-indicator">
                Bot is thinking <span class="thinking-dot"></span><span class="thinking-dot"></span><span class="thinking-dot"></span>
            </span>
        </div>
    </div>

    <form class="chat-input-area" id="chatForm" method="POST" enctype="multipart/form-data" autocomplete="off">
        <label for="fileInput" class="attach-label" title="Attach file"><i class="fa fa-paperclip"></i></label>
        <input type="file" id="fileInput" name="file">
        <input type="text" class="form-control" id="chatInput" name="question" placeholder="Type your message..." required>
        <button type="submit" class="send-btn" id="sendBtn" title="Send">
            <span id="sendBtnText"><i class="fa fa-paper-plane"></i></span>
            <span id="chatSpinner" class="spinner-border" role="status"></span>
        </button>
    </form>
</div>

<script>
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTyping() {
        document.getElementById('typingIndicator').style.display = '';
        scrollToBottom();
    }

    function hideTyping() {
        document.getElementById('typingIndicator').style.display = 'none';
    }

    document.getElementById('chatInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('sendBtn').click();
        }
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const input = document.getElementById('chatInput');
        input.placeholder = e.target.files.length > 0
            ? 'Attached: ' + e.target.files[0].name
            : 'Type your message...';
    });

    document.getElementById('chatForm').addEventListener('submit', function() {
        showTyping();
        const btn = document.getElementById('sendBtn');
        btn.disabled = true;
        document.getElementById('sendBtnText').style.display = 'none';
        document.getElementById('chatSpinner').style.display = '';
    });

    window.addEventListener('DOMContentLoaded', function() {
        hideTyping();
        const btn = document.getElementById('sendBtn');
        btn.disabled = false;
        document.getElementById('sendBtnText').style.display = '';
        document.getElementById('chatSpinner').style.display = 'none';
        scrollToBottom();
    });

    function copySnippet(icon) {
        const pre = icon.closest('.snippet-box').querySelector('pre');
        if (pre) {
            navigator.clipboard.writeText(pre.innerText);
            const tooltip = icon.parentElement.querySelector('.copy-tooltip');
            if (tooltip) {
                tooltip.textContent = 'Copied!';
                setTimeout(() => tooltip.textContent = 'Copy', 1200);
            }
        }
    }
</script>
{% endblock %}
